

https://github.com/NVIDIA-ISAAC-ROS/nova_carter
https://github.com/NVIDIA-ISAAC-ROS/isaac_ros_mapping_and_localization
https://github.com/NVIDIA-ISAAC-ROS/isaac_ros_visual_slam/tree/main
https://github.com/NVIDIA-ISAAC-ROS/isaac_ros_examples/blob/main/isaac_ros_multicamera_vo/launch/isaac_ros_visual_slam_multihawk_carter.launch.py
https://github.com/NVIDIA-ISAAC-ROS/isaac_perceptor/tree/main/isaac_ros_perceptor_bringup
https://github.com/NVIDIA-ISAAC-ROS/isaac_ros_nova
https://github.com/NVIDIA-ISAAC-ROS/isaac_ros_nvblox

https://nvidia-isaac-ros.github.io/reference_workflows/isaac_perceptor/tutorial_mapping_and_localization.html
https://nvidia-isaac-ros.github.io/reference_workflows/isaac_perceptor/tutorials_on_carter/demo_perceptor.html
https://nvidia-isaac-ros.github.io/reference_workflows/isaac_perceptor/tutorials_on_carter/demo_navigation.html



cd ${ISAAC_ROS_WS}/src/isaac_ros_common && \
  ./scripts/run_dev.sh

ros2 launch nova_carter_bringup perceptor.launch.py stereo_camera_configuration:=front_configuration OR front_left_right_configuration
ros2 launch nova_carter_bringup navigation.launch.py stereo_camera_configuration:=front_left_right_configuration map_yaml_path:=<PATH_TO_MAP_FOLDER>/occupancy_map.yaml enable_visual_localization:=True vslam_load_map_folder_path:=<PATH_TO_MAP_FOLDER>/cuvslam_map/ vgl_map_dir:=<PATH_TO_MAP_FOLDER>/cuvgl_map vslam_enable_slam:=True


  - Generate maps using `create_map_offline.py`
  - cuVSLAM for mapping and localization
  - visual global localizer (cuGVL) for initial pose setting or if need to relocalize mid-task
  - Pre-test using https://nvidia-isaac-ros.github.io/reference_workflows/isaac_perceptor/tutorial_mapping_and_localization.html#quickstart-with-a-pre-recorded-rosbag
    - Rosbag to run instructions to test working before on hardware
  
  - cuVSLAM Mapping:
    - record using all cameras (nova carter front-back-left-right) https://github.com/NVIDIA-ISAAC-ROS/isaac_ros_nova/blob/main/isaac_ros_nova/config/nova-carter_hawk-4_no-3d-lidar.yaml
    - Drive around 1+ minute per 5x5m area
    - Start with 10s still at start for later localization testing
    - Drive in loops to close, make sure to capture objects at > 1 angle, don't drive for a long time in astright line
    - Use graphic: https://media.githubusercontent.com/media/NVIDIA-ISAAC-ROS/.github/main/resources/isaac_ros_docs/concepts/visual_slam/cuvslam/Mapping_openspace.gif/
    - Use graphic: https://media.githubusercontent.com/media/NVIDIA-ISAAC-ROS/.github/main/resources/isaac_ros_docs/concepts/visual_slam/cuvslam/Mapping_thincorridor.gif/

    - (1) Get mapping data (https://nvidia-isaac-ros.github.io/repositories_and_packages/isaac_ros_nova/isaac_ros_data_recorder/index.html AND https://nvidia-isaac-ros.github.io/repositories_and_packages/isaac_ros_nova/isaac_ros_nova_recorder/index.html#quickstart)
    ```
    sudo apt-get install -y ros-humble-isaac-ros-nova-recorder ros-humble-isaac-ros-data-recorder
    ros2 launch isaac_ros_data_recorder data_recorder.launch.py
    ros2 launch isaac_ros_nova_recorder nova_recorder.launch.py config:=nova-carter headless:=True
    ```

    - (2) process map from data (https://nvidia-isaac-ros.github.io/reference_workflows/isaac_perceptor/tutorial_mapping_and_localization.html AND https://nvidia-isaac-ros.github.io/concepts/visual_global_localization/tutorials/tutorial_map_creation.html)
    ```
    Make sure the rosbag and output map folder path are mounted to the Docker container.
    You can add them in ${ISAAC_ROS_WS}/src/isaac_ros_common/scripts/.isaac_ros_dev-dockerargs then restart the container.

    # Launch Isaac ROS docker container:

    TODO

    # Get mapping packages
    sudo apt-get install -y ros-humble-isaac-mapping-ros
    sudo apt-get install -y ros-humble-isaac-ros-visual-slam

    # Models
    sudo apt-get install -y ros-humble-isaac-ros-peoplesemseg-models-install ros-humble-isaac-ros-ess-models-install
    source /opt/ros/humble/setup.bash    
    ros2 run isaac_ros_ess_models_install install_ess_models.sh --eula
    ros2 run isaac_ros_peoplesemseg_models_install install_peoplesemsegnet_vanilla.sh --eula
    ros2 run isaac_ros_peoplesemseg_models_install install_peoplesemsegnet_shuffleseg.sh --eula

    ros2 run isaac_mapping_ros create_map_offline.py --sensor_data_bag=<PATH_TO_BAG> --base_output_folder=<PATH_TO_OUTPUT_FOLDER>
    #or?
    ros2 run isaac_mapping_ros run_rosbag_to_mapping_data.py \
      --sensor_data_bag=$SENSOR_DATA_BAG --pose_bag=$POSE_BAG --output_folder="$MAP_FOLDER/keyframes" \
      --extract_feature --rot_dist=5 --trans_dist=0.2 \
      --pose_topic_name <POSE_TOPIC_NAME>
    ros2 run isaac_mapping_ros create_cuvgl_map.py --map_folder=$MAP_FOLDER --no-extract_feature
    ros2 run isaac_mapping_ros create_cuvgl_map.py --map_folder=$MAP_FOLDER --no-extract_feature --no-build_bow_voc
    ```

  - (3) cuVSLAM Localization
    - `--disable_vgl` if we disable VGL or run on startup
    - `--occupancy_map_yaml_file` will publish map as a nav2::OccupancyGridMap

    ```
    export RECORDINGS_FOLDER=/mnt/nova_ssd/recordings
    export MAPS_FOLDER=/mnt/nova_ssd/maps
    docker pull nvcr.io/nvidia/isaac/nova_carter_bringup:release_3.2-aarch64
    docker run --privileged --network host \
      -v /dev/*:/dev/* \
      -v /tmp/argus_socket:/tmp/argus_socket \
      -v /etc/nova:/etc/nova \
      -v $RECORDINGS_FOLDER:$RECORDINGS_FOLDER -v $MAPS_FOLDER:$MAPS_FOLDER \
      nvcr.io/nvidia/isaac/nova_carter_bringup:release_3.2-aarch64 \
      ros2 launch nova_carter_bringup perceptor.launch.py stereo_camera_configuration:=front_left_right_configuration disable_vgl:=False vslam_load_map_folder_path:=<PATH_TO_MAP_FOLDER>/cuvslam_map/ vgl_map_dir:=<PATH_TO_MAP_FOLDER>/cuvgl_map/ occupancy_map_yaml_file:=<PATH_TO_MAP_FOLDER>/occupancy_map.yaml vslam_enable_slam:=True
    

    # or as binaries
    sudo apt-get install -y ros-humble-nova-developer-kit-bringup 
    ros2 launch nova_developer_kit_bringup perceptor.launch.py stereo_camera_configuration:=front_left_right_configuration disable_vgl:=False vslam_load_map_folder_path:=<PATH_TO_MAP_FOLDER>/cuvslam_map/ vgl_map_dir:=<PATH_TO_MAP_FOLDER>/cuvgl_map/ occupancy_map_yaml_file:=<PATH_TO_MAP_FOLDER>/occupancy_map.yaml vslam_enable_slam:=True
    ros2 launch isaac_ros_visual_slam isaac_ros_visual_slam_hawk.launch.py
    ```

  - (4) VGL https://nvidia-isaac-ros.github.io/repositories_and_packages/isaac_ros_mapping_and_localization/isaac_ros_visual_global_localization/index.html
    - Automatically runs with perceptor
    - If want to run separately:
    ```
    sudo apt-get install -y ros-humble-isaac-ros-visual-global-localization
    ros2 launch visual_global_localization isaac_ros_visual_global_localization_node.launch.py
    ros2 launch isaac_ros_multicamera_vo isaac_ros_visual_slam_multihawk_carter.launch.py use_rosbag:=False
    ```


  - (5) NvBlox
  - Get assets ffrom NGC (https://nvidia-isaac-ros.github.io/repositories_and_packages/isaac_ros_nvblox/isaac_ros_nvblox/index.html#quickstart)
  ```
    NGC_ORG="nvidia"
  NGC_TEAM="isaac"
  PACKAGE_NAME="isaac_ros_nvblox"
  NGC_RESOURCE="isaac_ros_nvblox_assets"
  NGC_FILENAME="quickstart.tar.gz"
  MAJOR_VERSION=3
  MINOR_VERSION=2
  VERSION_REQ_URL="https://catalog.ngc.nvidia.com/api/resources/versions?orgName=$NGC_ORG&teamName=$NGC_TEAM&name=$NGC_RESOURCE&isPublic=true&pageNumber=0&pageSize=100&sortOrder=CREATED_DATE_DESC"
  AVAILABLE_VERSIONS=$(curl -s \
      -H "Accept: application/json" "$VERSION_REQ_URL")
  LATEST_VERSION_ID=$(echo $AVAILABLE_VERSIONS | jq -r "
      .recipeVersions[]
      | .versionId as \$v
      | \$v | select(test(\"^\\\\d+\\\\.\\\\d+\\\\.\\\\d+$\"))
      | split(\".\") | {major: .[0]|tonumber, minor: .[1]|tonumber, patch: .[2]|tonumber}
      | select(.major == $MAJOR_VERSION and .minor <= $MINOR_VERSION)
      | \$v
      " | sort -V | tail -n 1
  )
  if [ -z "$LATEST_VERSION_ID" ]; then
      echo "No corresponding version found for Isaac ROS $MAJOR_VERSION.$MINOR_VERSION"
      echo "Found versions:"
      echo $AVAILABLE_VERSIONS | jq -r '.recipeVersions[].versionId'
  else
      mkdir -p ${ISAAC_ROS_WS}/isaac_ros_assets && \
      FILE_REQ_URL="https://api.ngc.nvidia.com/v2/resources/$NGC_ORG/$NGC_TEAM/$NGC_RESOURCE/\
  versions/$LATEST_VERSION_ID/files/$NGC_FILENAME" && \
      curl -LO --request GET "${FILE_REQ_URL}" && \
      tar -xf ${NGC_FILENAME} -C ${ISAAC_ROS_WS}/isaac_ros_assets && \
      rm ${NGC_FILENAME}
  fi

  NGC_ORG="nvidia"
  NGC_TEAM="isaac"
  PACKAGE_NAME="isaac_ros_visual_slam"
  NGC_RESOURCE="isaac_ros_visual_slam_assets"
  NGC_FILENAME="quickstart.tar.gz"
  MAJOR_VERSION=3
  MINOR_VERSION=2
  VERSION_REQ_URL="https://catalog.ngc.nvidia.com/api/resources/versions?orgName=$NGC_ORG&teamName=$NGC_TEAM&name=$NGC_RESOURCE&isPublic=true&pageNumber=0&pageSize=100&sortOrder=CREATED_DATE_DESC"
  AVAILABLE_VERSIONS=$(curl -s \
      -H "Accept: application/json" "$VERSION_REQ_URL")
  LATEST_VERSION_ID=$(echo $AVAILABLE_VERSIONS | jq -r "
      .recipeVersions[]
      | .versionId as \$v
      | \$v | select(test(\"^\\\\d+\\\\.\\\\d+\\\\.\\\\d+$\"))
      | split(\".\") | {major: .[0]|tonumber, minor: .[1]|tonumber, patch: .[2]|tonumber}
      | select(.major == $MAJOR_VERSION and .minor <= $MINOR_VERSION)
      | \$v
      " | sort -V | tail -n 1
  )
  if [ -z "$LATEST_VERSION_ID" ]; then
      echo "No corresponding version found for Isaac ROS $MAJOR_VERSION.$MINOR_VERSION"
      echo "Found versions:"
      echo $AVAILABLE_VERSIONS | jq -r '.recipeVersions[].versionId'
  else
      mkdir -p ${ISAAC_ROS_WS}/isaac_ros_assets && \
      FILE_REQ_URL="https://api.ngc.nvidia.com/v2/resources/$NGC_ORG/$NGC_TEAM/$NGC_RESOURCE/\
  versions/$LATEST_VERSION_ID/files/$NGC_FILENAME" && \
      curl -LO --request GET "${FILE_REQ_URL}" && \
      tar -xf ${NGC_FILENAME} -C ${ISAAC_ROS_WS}/isaac_ros_assets && \
      rm ${NGC_FILENAME}
  fi
  ```

  ```
  sudo apt-get install -y ros-humble-isaac-ros-nvblox
  ```

  ```
      nvblox_layer:
        plugin: "nvblox::nav2::NvbloxCostmapLayer"
        enabled: True
        nav2_costmap_global_frame: map # must match with global_frame of global_costmap
        nvblox_map_slice_topic: "/nvblox_node/static_map_slice"
        convert_to_binary_costmap: True
  ```


CONFIG:
  - MPPI 
  - Goal checker with 2PI orientation checking for just XY use since the goals have no tolerance
  - BT using graph navigation with off graph connections (make sure not to compute if trivialized / on graph)
  - NavFn otherwise or Smac?
  - 